name: setup-sysext-root
type: shell
commands:
  - PRETTY_VERSION=$(cat /version.json | jq -r ".version_id")
  - TAG=$(cat /version.json | jq -r ".tag")
  - IMAGE_ID=$(cat /version.json | jq -r ".image_id")
  - VERSION=${TAG}.${IMAGE_ID}

  - rm /sysroot/etc/os-release
  - rm /sysroot/usr/lib/os-release

  - |
    cat <<EOF > /sysroot/usr/lib/extension-release.d/extension-release.nvidia-modules_${VERSION}
    ID=project.shards
    VERSION_ID=${PRETTY_VERSION}
    SYSEXT_LEVEL=${VERSION}
    SYSEXT_SCOPE=initrd system
    EOF
