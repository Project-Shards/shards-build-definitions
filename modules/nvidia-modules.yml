name: nvidia-modules
#type: pacman
#ExtraFlags:
#  - "-dd"
#  - "--sysroot=/sysroot-modules"
#packages:
#  - nvidia
type: shell
sources:
  - type: file
    url: https://us.download.nvidia.com/XFree86/Linux-x86_64/565.57.01/NVIDIA-Linux-x86_64-565.57.01.run
    checksum: 6eebe94e585e385e8804f5a74152df414887bf819cc21bd95b72acd0fb182c7a
commands:
  - cd /sources/nvidia-modules/NVIDIA-Linux-x86_64-565.57.01
  - sh *.run -x
  - cd "NVIDIA-Linux-x86_64-565.57.01/kernel"
  - kernel_version=$(basename /usr/lib/modules/*)
  - echo "EXTRA_CFLAGS+=-Wno-error=incompatible-pointer-types" >> Kbuild
  - make KERNEL_UNAME="$(basename /usr/lib/modules/*)"
  - make -j1 KERNEL_UNAME="${kernel_version}" modules_install INSTALL_MOD_PATH='/sysroot-modules/usr'
  - pacman -Rdd --sysroot='/sysroot-modules' --noconfirm linux linux-headers


modules:
#  - name: mods-pacman-setup
#    type: includes
#    includes:
#      - modules/setup-pacman.yml
  - name: sysroot-setup
    type: shell
    commands:
      - cp -r /sysroot /sysroot-modules
  - name: linux
    type: pacman
    ExtraFlags:
      - "-dd"
      - "--sysroot=/sysroot-modules"
    packages:
      - linux
      - linux-headers
