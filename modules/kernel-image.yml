name: kernel-image
type: shell
commands:
  - CMDLINE="rw systemd.debug-shell=1 mount.usrflags=ro mount.usrfstype=erofs systemd.firstboot=no"

  - VERSION=$(ls -1 /sysroot/lib/modules | head -n1)
  - ROOTHASH=$(jq -r '(.[] | select(.type | match("^usr-.*-verity$"))).roothash' /cleanup/usrimage/repart.json)
  - CMDLINE="${CMDLINE} usrhash=${ROOTHASH}"
  - label=$(jq -r '(.[] | select(.type | match("^usr-.*-verity$"))).label' /cleanup/usrimage/repart.json)
  - image_version="${label##shards_usr_v_}"
  
  - mkdir -p /efi/EFI/Linux
  - cp -r /sysroot/usr/lib/tmpfiles.d/20-systemd-stub.conf /usr/lib/tmpfiles.d/20-systemd-stub.conf
  - cp -r /sysroot/usr/lib/repart.d /usr/lib/repart.d
  - generate-initramfs /initramfs-root "${VERSION}" "/usr/lib" "/usr/lib/systemd"
  - cp -r /initramfs-root/sysroot/usr/* /initramfs-root/usr/
  - mkdir -p /initramfs-root/usr/lib/modules/"${VERSION}"/kernel/drivers/video
  - depmod -a -b /initramfs-root/usr "${VERSION}"
  - cd /initramfs-root
  - find . -print0 | sort -z | cpio --reproducible --null -H newc -o --quiet | xz --check=crc32 --lzma2=dict=1MiB -T0 >/initramfs.img

  - cd /sources/kernel-image/signing-keys

  - ukify build --pcr-private-key=tpm2-pcr-private.pem --pcr-public-key=tpm2-pcr-public.pem --phases="enter-initrd,enter-initrd:leave-initrd,enter-initrd:leave-initrd:sysinit" --secureboot-private-key=VENDOR.key --secureboot-certificate=VENDOR.crt --linux=/sysroot/usr/lib/modules/${VERSION}/vmlinuz --initrd=/initramfs.img --cmdline="${CMDLINE}" --output=/efi/EFI/Linux/shards_${image_version}.efi

  - mkdir -p /efi/loader/keys/auto
  - mkdir -p /efi/loader/keys/private
  - cp /sysroot/usr/share/efitools/efi/PK.auth /efi/loader/keys/private/PK.auth
  - cp /sysroot/usr/share/efitools/efi/KEK.auth /efi/loader/keys/private/KEK.auth
  - cp /sysroot/usr/share/efitools/efi/DB.auth /efi/loader/keys/private/DB.auth
  - cp /sysroot/usr/share/efitools/efi/PK-mic.auth /efi/loader/keys/auto/PK.auth
  - cp /sysroot/usr/share/efitools/efi/KEK-mic.auth /efi/loader/keys/auto/KEK.auth
  - cp /sysroot/usr/share/efitools/efi/DB-mic.auth /efi/loader/keys/auto/DB.auth
  - SYSTEMD_ESP_PATH=/efi bootctl install --no-variables

  - cp "/efi/EFI/Linux/shards_${image_version}.efi" "/cleanup/update-images/shards_${image_version}.efi"
  - xz -T$(nproc) "/cleanup/update-images/shards_${image_version}.efi"

sources:
  - type: local
    url: files/signing-keys

modules:
  - name: kernel-image-deps
    type: includes
    includes:
      - modules/efitools.yml
      - modules/shim.yml
